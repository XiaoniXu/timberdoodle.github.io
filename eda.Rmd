---
title: "EDA"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE, message=FALSE}
library(auk)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(lubridate)
library(readr)
library(sf)
library(kableExtra)
library(leaflet)

# Set default figure options
knitr::opts_chunk$set(
  fig.width = 6,
  out.width = "90%"
)
```


```{r, include=FALSE, message=FALSE}
observations_selected = read_csv("data/observations_selected_clean.csv")
```

We make a simple map of the observations. This map uses GIS data.
```{r}
# load gis data
ne_land <- read_sf("data/gis-data.gpkg", "ne_land") |> 
  st_geometry()
ne_country_lines <- read_sf("data/gis-data.gpkg", "ne_country_lines") |> 
  st_geometry()
ne_state_lines <- read_sf("data/gis-data.gpkg", "ne_state_lines") |> 
  st_geometry()
study_region <- read_sf("data/gis-data.gpkg", "ne_states") |> 
  filter(state_code == "US-NY") |> 
  st_geometry()

# prepare ebird data for mapping

checklists <- zf_filtered |> 
  select(checklist_id, observer_id, 
         observation_count, species_observed, 
         state_code, locality_id, latitude, longitude,
         protocol_type, all_species_reported,
         observation_date, year, day_of_year,
         hours_of_day, 
         effort_hours, effort_distance_km, effort_speed_kmph,
         number_observers)

checklists_sf <- checklists |> 
  # convert to spatial points
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |> 
  select(species_observed)

# map
par(mar = c(0.25, 0.25, 4, 0.25))
# set up plot area
plot(st_geometry(checklists_sf), 
     main = "American Woodcock eBird Observations 2019-2024",
     col = NA, border = NA)
# contextual gis data
plot(ne_land, col = "#cfcfcf", border = "#888888", lwd = 0.5, add = TRUE)
plot(study_region, col = "#e6e6e6", border = NA, add = TRUE)
plot(ne_state_lines, col = "#ffffff", lwd = 0.75, add = TRUE)
plot(ne_country_lines, col = "#ffffff", lwd = 1.5, add = TRUE)
# ebird observations
# not observed
plot(filter(checklists_sf, !species_observed),
     pch = 19, cex = 0.1, col = alpha("#555555", 0.25),
     add = TRUE)
# observed
plot(filter(checklists_sf, species_observed),
     pch = 19, cex = 0.3, col = alpha("#4daf4a", 1),
     add = TRUE)
# legend
legend("bottomright", bty = "n",
       col = c("#555555", "#4daf4a"),
       legend = c("eBird checklist", "American Woodcock sighting"),
       pch = 19)
box()
```

**Does the season affect the activity of woodcocks?**

```{r}
observations_selected <- observations_selected |> 
  mutate(season = factor(season, levels = c("Winter", "Spring", "Summer", "Fall")))

season_summary <- observations_selected |> 
  group_by(season) |> 
  summarise(total_observation_count = sum(observation_count, na.rm = TRUE))

ggplot(season_summary, aes(x = season, y = total_observation_count, fill = season)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Winter" = "#56B4E9", 
                               "Spring" = "#009E73", 
                               "Summer" = "#F0E442", 
                               "Fall" = "#E69F00")) +
  labs(
    title = "Observation Count of Woodcocks by Season in NY",
    x = "Season", 
    y = "Total Observation Count"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```



The total observation count in Spring in NY is significantly higher than in any other season...

**When do American woodcocks usually appear?**

```{r}
observations_selected <- observations_selected |> 
  mutate(time_of_day = factor(time_of_day, levels = c("Morning", "Afternoon", "Evening", "Night")))

# Summarize observation counts by time of day
time_summary <- observations_selected |> 
  group_by(time_of_day) |> 
  summarise(total_observation_count = n())

# Create the plot
ggplot(time_summary, aes(x = time_of_day, y = total_observation_count, fill = time_of_day)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c(
    "Morning" = "#FFD700", 
    "Afternoon" = "#FFA500", 
    "Evening" = "#1E90FF",  
    "Night" = "#4B0082" 
  )) +
  labs(
    title = "Observation Count by Time of Day",
    x = "Time of Day",
    y = "Total Observation Count"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

Are the difference significant?

```{r}
kruskal_test <- kruskal.test(observation_count ~ time_of_day, data = observations_selected)

# Extract test results
kruskal_result <- data.frame(
  Statistic = round(kruskal_test$statistic, 3),
  Degrees_of_Freedom = kruskal_test$parameter,
  P_Value = format.pval(kruskal_test$p.value, digits = 3, scientific = TRUE)
)

# Save results as a nice table
kruskal_result |> 
  kbl(caption = "Kruskal-Wallis Test Results") |> 
  kable_classic(full_width = FALSE, html_font = "Times")
```

There is strong evidence that the observation counts differ significantly across the time periods (Morning, Afternoon, Evening, Night).


**Observation Counts by County**

```{r}
# Summarize the data by county
county_summary <- observations_selected |> 
  filter(!is.na(county)) |> 
  group_by(county) |> 
  summarise(total_observation_count = sum(observation_count, na.rm = TRUE))

# Create a bar plot
ggplot(county_summary, aes(x = reorder(county, -total_observation_count), y = total_observation_count, fill = total_observation_count)) +
  geom_bar(stat = "identity") +
  scale_fill_gradient(low = "#4daf4a", high = "#163315", name = "Count") +
  labs(
    title = "Observation Counts by County",
    x = "County",
    y = "Total Observation Count"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "bottom")
```


